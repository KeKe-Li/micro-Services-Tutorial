### micro-Services-Tutorial


#### promethues和grafana监控

在使用微服务架构的时候，需要链路监控，可视化和仪表盘显示，方便开发工程师查看到微服务中的组件和服务。可视化的dashboar可以用promethues和grafana结合一起使用显示。用promethues进行收集数据，grafana 进行数据的展示.
<p align="center">
<img width="100%" align="center" src="../images/1.jpg" />
</p>

prometheus的特点主要包括：

* 多维数据模型（时序列数据由metric名和一组key/value组成）.
* 在多维度上灵活的查询语言(PromQl).
* 不依赖分布式存储，单主节点工作.
* 通过基于HTTP的pull方式采集时序数据.
* 可以通过中间网关进行时序列数据推送(pushing).
* 目标服务器可以通过发现服务或者静态配置实现.
* 多种可视化和仪表盘支持.

promethues和grafana监控整个系统使用了三个组件：

* node-exporter：运行在主机上收集操作系统上各种数据的 agent，promethues 中称为 exporter.
* prometheus：开源的时序数据库，作为数据存储和分析的中心.
* grafana：数据展示分析界面，提供各种强大的 dashboard，可以从多个数据源读取数据，其中就包括 promethues.

prometheus的架构和部署

我们创建一个 docker-compose.yml 文件，里面只包含 promethues 一个服务：
```docker-compose
version: '2'
services:
  prometheus:
    image: prom/prometheus:v2.0.0
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    ports:
      - '9090:9090'
```
* image 后面指定了使用的 promethues 容器镜像，该文件使用的是 v2.0.0 版本.
* volumes 把当前目录下面的 prometheus.yml 文件挂载到容器里，这样是因为后面会一直修改这个文件，利用 volume 挂载的方式比较灵活.
* command 指定了 promethues 运行的命令行参数，这里只指定配置文件的位置，更多参数可以使用 --help 来查看.
* ports 把 promethues 服务监听的端口映射到主机上，这样可以直接访问主机端口使用它.

其中比较重要的是prometheus.yml：
```docker-compose
global:
    scrape_interval: 5s
    external_labels:
        monitor: 'my-monitor'
scrape_configs:
    - job_name: 'prometheus'
      static_configs:
          - targets: ['localhost:9090']
```
配置文件一共分为两个部分：global 和 scrape_configs，global是全局的配置，如果后面的任务没有对特定配置项进行覆盖，这里的选项会生效。这里有两个配置项，scrape_interval 表示 promethues server 抓取的周期，如果太频繁会导致 promethues压力比较大，如果太久，可能会导致某些关键数据漏掉，推荐根据每个任务的重要性和集群规模分别进行配置。

scrape_configs 配置了每个抓取任务，因此是一个列表，这里我们只有一个任务，那就是抓取 promethues 本身的 metrics。配置里面最重要的是 static_configs.targets，表示要抓取任务的 HTTP 地址，默认会在 /metrics url 出进行抓取，比如这里就是 http://localhost:9090/。 这是 prometheus 本身提供的监控数据，可以在浏览器中直接查看。
